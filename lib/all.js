var mammamia = [[1508,"6","1"],[2495,"1","1"],[2692,"1","3"],[2890,"1","1"],[3087,"2","1"],[4666,"5","3"],[5061,"2","1"],[5653,"1","3"],[5850,"2","1"],[6245,"2","1"],[6640,"6","1"],[7035,"2","1"],[7429,"2","1"],[7824,"2","1"],[8219,"2","1"],[8811,"1","1"],[9008,"2","1"],[9600,"1","3"],[9798,"6","1"],[10192,"2","1"],[10587,"2","1"],[10982,"2","1"],[11771,"2","1"],[12166,"2","1"],[12363,"1","1"],[12561,"2","1"],[12956,"6","1"],[13350,"2","1"],[13745,"2","1"],[14140,"2","1"],[14929,"2","1"],[15324,"2","1"],[15719,"2","1"],[16113,"6","1"],[16508,"2","1"],[16903,"2","1"],[17495,"1","3"],[17692,"2","1"],[18087,"2","1"],[18482,"2","1"],[18877,"2","1"],[19469,"5","3"],[20061,"2","1"],[20653,"1","3"],[21048,"1","3"],[21245,"2","1"],[21640,"2","1"],[22035,"2","1"],[22429,"6","1"],[23219,"2","1"],[23613,"2","1"],[24798,"2","1"],[25192,"2","1"],[25587,"6","1"],[26377,"2","1"],[27363,"1","3"],[27561,"1","3"],[27758,"1","1"],[27956,"2","1"],[29337,"5","1"],[29535,"2","1"],[29929,"1",""],[30127,"1","1"],[30324,"2","1"],[30719,"2","1"],[31113,"2","1"],[31508,"2","1"],[32100,"5","3"],[32495,"1","1"],[32692,"2","1"],[33087,"2","1"],[34074,"1","1"],[34271,"2","1"],[34666,"2","1"],[35456,"6","1"],[36245,"2","1"],[36640,"2","1"],[37035,"2","1"],[37429,"2","1"],[38021,"1","1"],[38613,"6","1"],[39008,"2","1"],[39403,"2","1"],[39798,"2","1"],[40390,"1","1"],[40587,"2","1"],[41179,"1","3"],[41377,"6","1"],[41771,"2","1"],[42166,"2","1"],[42758,"1","1"],[42956,"2","1"],[43350,"2","1"],[44140,"2","1"],[44535,"6","1"],[44929,"2","1"],[45324,"2","1"],[45719,"2","1"],[46508,"2","1"],[46903,"2","1"],[47495,"1","3"],[48087,"6","1"],[48383,"1","1"],[48877,"2","1"],[49271,"2","1"],[49666,"2","1"],[50456,"2","1"],[50850,"6","1"],[52035,"2","1"],[52824,"2","1"],[53219,"2","1"],[54008,"6","1"],[54600,"1","1"],[54798,"2","1"],[55192,"2","1"],[56179,"1","1"],[56969,"1","3"],[57561,"6","1"],[58153,"1","1"],[58350,"2","1"],[59140,"2","1"],[59535,"2","1"],[59929,"2","1"],[60719,"6","1"],[61113,"2","1"],[61508,"2","1"],[62298,"2","1"],[62692,"2","1"],[63087,"2","1"],[63679,"5","1"],[63877,"2","1"],[64271,"2","1"],[64666,"2","1"],[65456,"2","1"],[66048,"1","1"],[66245,"2","1"],[66640,"6","1"],[67232,"1","1"],[67627,"1","3"],[67824,"2","1"],[68811,"1","1"],[69008,"2","1"],[69403,"2","1"],[69995,"5","3"],[70390,"1","1"],[70587,"2","1"],[70982,"2","1"],[71377,"2","1"],[71771,"2","1"],[72166,"2","1"],[72758,"1","3"],[73153,"5","1"],[73548,"1","1"],[73745,"2","1"],[74140,"2","1"],[74929,"2","1"],[75324,"2","1"],[75719,"2","1"],[76015,"1","1"],[76113,"6","1"],[76508,"2","1"],[76903,"2","1"],[77298,"2","1"],[77692,"2","1"],[78087,"2","1"],[78482,"2","1"],[78877,"2","1"],[79271,"6","1"],[79666,"2","1"],[80061,"2","1"],[80456,"2","1"],[80850,"2","1"],[81245,"2","1"],[81640,"2","1"],[82035,"2","1"],[82429,"6","1"],[82824,"2","1"],[83219,"2","1"],[84206,"1","3"],[84304,"1","3"],[84600,"1","1"],[85192,"2","1"],[85587,"6","1"],[85982,"2","1"],[86771,"2","1"],[87956,"2","1"],[88350,"2","1"],[88745,"6","1"],[89140,"2","1"],[89535,"2","1"],[89929,"2","1"],[90324,"2","1"],[90916,"1","1"],[91113,"2","1"],[92002,"5","1"],[92890,"1","1"],[93087,"2","1"],[93679,"1","3"],[94863,"1","1"],[95061,"6","1"],[95456,"2","1"],[95850,"2","1"],[96245,"2","1"],[96837,"1","1"],[97035,"2","1"],[97627,"1","3"],[97824,"2","1"],[98219,"6","1"],[98613,"2","1"],[99008,"2","1"],[99600,"1","1"],[100390,"1","3"],[100587,"2","1"],[101179,"1","1"],[101771,"6","1"],[102166,"2","1"],[102561,"2","1"],[102956,"2","1"],[103548,"1","1"],[103745,"2","1"],[104140,"2","1"],[104535,"6","1"],[104929,"2","1"],[105324,"2","1"],[105719,"2","1"],[106113,"2","1"],[106508,"2","1"],[107100,"1","3"],[107298,"2","1"],[108087,"6","1"],[108482,"2","1"],[108877,"2","1"],[109666,"2","1"],[110061,"2","1"],[111245,"5","3"],[111541,"1","3"],[112035,"2","1"],[112429,"2","1"],[112824,"2","1"],[113613,"2","1"],[114008,"6","1"],[114403,"2","1"],[114798,"2","1"],[115192,"2","1"],[115982,"2","1"],[116377,"2","1"],[117166,"6","1"],[117561,"2","1"],[117956,"2","1"],[118350,"2","1"],[119337,"1","3"],[119929,"2","1"],[120719,"6","1"],[121311,"1","3"],[121508,"2","1"],[122298,"2","1"],[122692,"2","1"],[123087,"2","1"],[123877,"6","1"],[124271,"2","1"],[124666,"2","1"],[125456,"2","1"],[125850,"2","1"],[126245,"2","1"],[127232,"5","1"],[127429,"2","1"],[127824,"2","1"],[128219,"2","1"],[128613,"2","1"],[129206,"1","3"],[129403,"2","1"],[129995,"5","1"],[130192,"2","1"],[130785,"1","3"],[130982,"2","1"],[131969,"1","1"],[132166,"2","1"],[132758,"1","1"],[132956,"6","1"],[133350,"2","1"],[133745,"2","1"],[134140,"2","1"],[134535,"2","1"],[134929,"2","1"],[135324,"2","1"],[135719,"2","1"],[136311,"5","1"],[136508,"2","1"],[136903,"2","1"],[137298,"2","1"],[137692,"2","1"],[138087,"2","1"],[138482,"2","1"],[138877,"2","1"],[139271,"6","1"],[139666,"2","1"],[140061,"2","1"],[140456,"2","1"],[140850,"2","1"],[141245,"2","1"],[141640,"2","1"],[142035,"2","1"],[142331,"1","3"],[142429,"6","1"],[142824,"2","1"],[143219,"2","1"],[143811,"1","3"],[144008,"2","1"],[144403,"2","1"],[144798,"2","1"],[145192,"2","1"],[146179,"5","1"],[146377,"1","3"],[146574,"1","3"],[146771,"2","1"],[147561,"2","1"],[147956,"2","1"],[148350,"2","1"],[149535,"6","1"],[149929,"2","1"],[151113,"1","1"],[151903,"6","1"],[152298,"2","1"],[152890,"1","3"],[153087,"2","1"],[153482,"2","1"],[153877,"2","1"],[154271,"2","1"],[154666,"2","1"],[155456,"6","1"],[156048,"1","1"],[156245,"2","1"],[157429,"2","1"],[157824,"2","1"],[158613,"6","1"],[159008,"2","1"],[159403,"2","1"],[160192,"2","1"],[160982,"2","1"],[162166,"6","1"],[162561,"2","1"],[163350,"2","1"],[164140,"2","1"],[164535,"6","1"],[164929,"2","1"],[165719,"2","1"],[166113,"2","1"],[166508,"2","1"],[167692,"6","1"],[168087,"2","1"],[168482,"2","1"],[168877,"2","1"],[169271,"2","1"],[169666,"2","1"],[170258,"1","1"],[170456,"2","1"],[171245,"6","1"],[172035,"2","1"],[172824,"2","1"],[173219,"2","1"],[173613,"2","1"],[174008,"6","1"],[174403,"2","1"],[174798,"2","1"],[175192,"2","1"],[175982,"2","1"],[176377,"2","1"],[176771,"2","1"],[177758,"5","3"],[177956,"2","1"],[178350,"2","1"],[178745,"2","1"],[179337,"1","3"],[179732,"1","3"],[179929,"2","1"],[180521,"5","1"],[180916,"1","3"],[181311,"1","3"],[181508,"2","1"],[181903,"2","1"],[182495,"1","1"],[182692,"2","1"],[183285,"1","3"],[183877,"6","1"],[184271,"2","1"],[184666,"2","1"],[184962,"1","3"],[185061,"2","1"],[185456,"2","1"],[185850,"2","1"],[186245,"2","1"],[186640,"6","1"],[187035,"2","1"],[187429,"2","1"],[187824,"2","1"],[188613,"2","1"],[189008,"2","1"],[189403,"2","1"],[189798,"6","1"],[190192,"2","1"],[190587,"2","1"],[190982,"2","1"],[191771,"2","1"],[192166,"2","1"],[192561,"2","1"],[192956,"6","1"],[193350,"2","1"],[193745,"2","1"],[194337,"1","3"],[194535,"2","1"],[194929,"2","1"],[195324,"2","1"],[195719,"2","1"],[197298,"6","1"],[197890,"1","1"],[198285,"1","3"],[198679,"1","1"],[198877,"2","1"],[199271,"6","1"],[199863,"1","3"]];
let time_on_screen = 1500;
class Combo {
  constructor() {
    this.combo = 0;
    this.counter = document.getElementById('combo');
    this.maxCombo = 0;
  }

  render() {
    if (this.combo) {
      this.counter.innerHTML = `${this.combo} combo`;
    } else {
      if (!this.counter.innerHTML) {
        return;
      }
      this.counter.innerHTML = 'miss';
    }
  }

  show() {
    this.counter.classList.remove('bounceOutRight');
    this.counter.classList.add('bounceInRight');
  }

  hide() {
    this.counter.classList.remove('bounceInRight');
    this.counter.classList.add('bounceOutRight');
  }

  up() {
    this.combo ++;
    this.show();
    if (this.combo > this.maxCombo) {
      this.maxCombo = this.combo;
    }
  }

  reset() {
    this.combo = 0;
    this.hide();
  }
}

class Drum {
  constructor() {
    this.stage = document.getElementById('canvas').getContext('2d');
    this.x = 234;
    this.y = 204;
    this.colorRim = 'white';
    this.colorCenter = 'lightgrey';
  }

  render() {
    this.drawCircle(31, this.colorRim);
    this.drawCircle(20, this.colorCenter);
  }

  tap(note) {
    if (note.id === 'kat') {
      this.colorRim = 'skyblue';
    } else {
      this.colorCenter = 'orangered';
    }

    setTimeout(() => {
      this.colorRim = 'white';
      this.colorCenter = 'lightgrey';
    }, 100);
  }

  drawCircle(radius, color) {
    let stage = this.stage;
    stage.beginPath();
    stage.arc(this.x, this.y, radius, 0, 2 * Math.PI);
    stage.fillStyle = color;
    stage.fill();
  }

  flash() {
    // let stage = this.stage;
    // stage.beginPath();
    // stage.fillStyle = '#ffe92b';
    // stage.fillRect(150, 150, 80, 160);
  }
}

class DrumKey {
  constructor(drum, key) {
    this.drum = drum;
    this.key = key;
  }

  register(note) {
    this.type = note.id;

    document.addEventListener('keydown', e => {
      if (this.key === e.key) {
        this.pressed = true;
        note.currentTime = 0;
        note.play();
        this.drum.tap(note);
        setTimeout(() => {
          this.pressed = false;
        }, 100)
      }
    });

    document.addEventListener('keyup', e => {
      if (this.key === e.key.toLowerCase()) {
        this.pressed = false;
      }
    });
  }
}

class Note {
  constructor(vel, color, type,time) {
    this.x = 800;
    this.y = 173;
    this.vel = vel;
    this.id = Date.now();
    this.color = color;
    this.type = type;
    this.time = time;

    this.image = new Image();
    this.image.src = `./gifs/${color}_chestnut_note_500.png`;

    this.stage = document.getElementById('canvas').getContext('2d');
  }

  move(timer) {
    this.x = Math.floor(((this.time-timer)/time_on_screen)*566+234);
  }

  render() {
    this.stage.drawImage(this.image, this.x, this.y);
  }
}

class Score {
  constructor() {
    this.counter = document.getElementById('score-counter');
    this.score = 0;
  }

  render() {
    this.counter.innerHTML = this.score;
  }

  up(spirit) {
    let multiplier = spirit / 100;
    let score = Math.floor(100 * multiplier + 100);
    this.score += score;
  }
}

class SpiritGauge {
  constructor() {
    this.x = 340;
    this.y = 67;
    this.stage = document.getElementById('canvas').getContext('2d');
    this.spirit = 0;
    this.maxSpirit = 1000;
    this.maxWidth = 400;
  }

  render() {
    let stage = this.stage;
    stage.beginPath();
    stage.rect(this.x, this.y, this.maxWidth, 40);
    stage.fillStyle = 'white';
    stage.fillRect(this.x, this.y, this.maxWidth, 40);
    stage.lineWidth = 3;
    stage.strokeStyle = 'black';
    stage.stroke();

    this.bar();
    this.lit();
  }

  up(combo) {
    if (this.spirit < this.maxSpirit) {
      let spirit = 1 + combo;
      this.spirit += spirit;
    }
  }

  down() {
    if (this.spirit > 0) {
      this.spirit --;
    }
  }

  bar() {
    let width = this.spirit / this.maxSpirit * this.maxWidth;
    if (width >= this.maxWidth) {
      width = this.maxWidth;
      this.full = true;
    } else {
      this.full = false;
    }
    this.stage.fillStyle = '#ffe92b';
    this.stage.fillRect(this.x + 3, this.y + 3, width, 34);
  }

  lit() {
    let fire = document.getElementById('fire');
    if (this.full) {
      fire.classList.remove('hide');
    } else {
      fire.classList.add('hide');
    }
  }
}

class ToggleMusic {
  constructor(music) {
    this.music = music;
    this.volumeOn = document.getElementById('volume-on');
    this.volumeOff = document.getElementById('volume-off');
    this.musicMute = document.querySelector('.music-mute');
    this.init();
  }

  init() {
    this.musicMute.addEventListener('click', e => this.render());
    document.addEventListener('keypress', e => {
      if (e.code === 'KeyM') {
        this.render();
      }
    });
  }

  render() {
    this.music.muted = this.music.muted ? false : true;
    this.volumeOn.classList.toggle('hide', this.music.muted);
    this.volumeOff.classList.toggle('hide', !this.music.muted);
  }
}

class TogglePlay {
  constructor() {
    this.gameOn = false;
    this.play = document.getElementById('play');
    this.pause = document.getElementById('pause');
  }

  render() {
    this.gameOn = this.gameOn ? false : true;
    this.play.classList.toggle('hide', this.gameOn);
    this.pause.classList.toggle('hide', !this.gameOn);
  }
}

const buttonPositions = {
  bluearea1: {
    x: 0,
    y: 260,
    width: 250,
    height: 200
  },
  bluearea2: {
    x: 500,
    y: 260,
    width: 250,
    height: 200
  },
  pinkarea: {
    x: 260,
    y: 260,
    width: 300,
    height: 150
  }
};

function isInside(pos, rect, desc){
  return pos.x > rect.x && pos.x < rect.x+rect.width && pos.y < rect.y+rect.height && pos.y > rect.y
}

// Get the mouse position
function getMousePos(canvas, e) {
    var rect = canvas.getBoundingClientRect();
    return {
        x: Math.round((e.clientX - rect.left)/(rect.right - rect.left)*canvas.width),
        y: Math.round((e.clientY - rect.top)/(rect.bottom - rect.top)*canvas.height)
    };
}



document.addEventListener('DOMContentLoaded', () => {
  const mammamiaAudio = document.createElement('audio');
  mammamiaAudio.src = "./sounds/audio.mp3";
  mammamiaAudio.bpm = 152;


  const don = new Audio();
  const kat = new Audio();
  don.id = 'don';
  kat.id = 'kat';
  don.src = './sounds/don.mp3';
  kat.src = './sounds/kat.mp3';

  let songLib = [mammamiaAudio];
  let songId = Math.floor(Math.random() * songLib.length);
  let music = songLib[songId];
  music.volume = 0.5;

  const toggleMusic = new ToggleMusic(music);
  const togglePlay = new TogglePlay();
  const canvas = document.getElementById('canvas');
  const stage = canvas.getContext('2d');
  const score = new Score();
  const spiritGauge = new SpiritGauge();
  const combo = new Combo();
  const drum = new Drum();

  // function NotesArea() {
  //   stage.beginPath();
  //   stage.lineWidth = 5;
  //   stage.moveTo(0, 150);
  //   stage.lineTo(800, 150);
  //   stage.stroke();
  //   stage.fillStyle = 'lightgrey';
  //   stage.fillRect(0, 150, 800, 200);
  //   stage.fillStyle = 'black';
  //   stage.fillRect(0, 310, 800, 40);
  //   stage.fill();
  // }

  const keyA = new DrumKey(drum, 'ArrowLeft');
  const keyB = new DrumKey(drum, 'ArrowRight');
  const drumKeys = [keyA, keyB];
  keyA.register(don);
  keyB.register(kat);

   function togglePause() {
      if (musicOn) {
        musicOn = false;
        pauseStart = Date.now();
        music.pause();
      } else {
        musicOn = true;
        // console.log(pauseStart);
        // console.log(timePaused);
        timePaused = Math.ceil(Date.now()-pauseStart)+timePaused;
        // console.log(timePaused)
        music.play();
      }
      togglePlay.render();
  
      gameOn = gameOn ? false : true;
      update();
  }

  // On mouse button click
  function onMouseDown(e) {
      // Get the mouse position
      var pos = getMousePos(canvas, e);
      // console.log(pos.x, pos.y);
      // console.log(e.clientX,e.clientY)
      if (!gameOn) {
        console.log('game not on')
        togglePause();
        modal.classList.add('hide');
      }
      //TODO: song selection and game state
      // if (gamestate == gamestates.gameover) {
      //     newGame();
      // } else if (gamestate == gamestates.win) {
      //     endscreen.style.display = 'none';

      //     var tilefound = false
      //     for (var i=0; i<level.columns; i++) {
      //         for (var j=0; j<level.rows; j++) {
      //             if (level.tiles[i][j].type != -1) {
      //                 tilefound = true;
      //                 break;
      //             }
      //         }
      //     }

      //     if (!tilefound) {
      //         createLevel();
      //     }
      //     setGameState(gamestates.ready)
      // } else if (gamestate == gamestates.displaygif){
      //     gifs[gifnum].style.display = 'none';
      //     // closebutton.style.display = 'none';
      //     gifnum = (gifnum + 1)%5;
      //     setGameState(gamestates.removecluster);
      // }
      else if (isInside(pos,buttonPositions["bluearea1"],"bluearea1") || isInside(pos,buttonPositions["bluearea2"],"bluearea2") ) {
             // console.log("kat")
            keyB.pressed = true;
            kat.currentTime = 0;
            kat.play();
            keyB.drum.tap(kat);
            setTimeout(() => {
              keyB.pressed = false;
            }, 10)
      }
      else if (isInside(pos,buttonPositions["pinkarea"],"pinkarea")) {
            // console.log("don")
            keyA.pressed = true;
            don.currentTime = 0;
            don.play();
            keyA.drum.tap(don);
            setTimeout(() => {
              keyA.pressed = false;
            }, 10)
      }
      // else if (isInside(pos,directionButtons["rightButton"])) {
      //     console.log("right")
      //     mousedownright = true;
      //     if (IS_MOBILE){
      //         console.log("mobile right")
      //         player.angle = Math.max(8, player.angle-2);
      //         if (charframe == 2) {
      //             charframe = 3;
      //         } else if (charframe == 3) {
      //             charframe = 1;
      //         } else if (charframe == 1) {
      //             charframe = 2;
      //         } else if (charframe == 0) {
      //             charframe = 1;
      //         };
      //     }
        //player.angle = Math.max(8, player.angle-2);
      // }
      //TODO: Can use this for song selection
      // for (var i=0;i<unlockIndex;i++){
      //     if (isInside(pos,playerButtons[i])){
      //         player.selectedSprite = i;
      //     }
      // }
  }

  function onMouseUp(e) {
      // Get the mouse position
      keyA.pressed = false;
      keyB.pressed = false;
  }
  function onTouchStart(e){
    e.clientX = e.touches[0].clientX;
    e.clientY = e.touches[0].clientY;
    // console.log("Touching",e.clientX,e.clientY)
    onMouseDown(e);
  }
  function onTouchEnd(e){
      // console.log("Touch ended");
      onMouseUp(e);
  }
  canvas.addEventListener("mousedown", onMouseDown);
  canvas.addEventListener("touchstart", onTouchStart);
  canvas.addEventListener("touchend", onTouchEnd);
  canvas.addEventListener("mouseup", onMouseUp);



  function setupStage() {
    // NotesArea();
    drum.render();
    score.render();
    // spiritGauge.render();
    // combo.render();
  }
  setupStage();

  let musicOn, gameOn, gameEnded;
  let pauseStart = Date.now();
  let timePaused = 0;
  let msg = document.getElementById('msg');
  let restart = document.getElementById('restart');
  let modal = document.querySelector('.modal');
  let playPause = document.querySelector('.play-pause');

  playPause.addEventListener('click', () => togglePause());
  restart.addEventListener('click', () => location.reload());
  modal.addEventListener('click', () => {
    if (!gameEnded) {
      togglePause();
      modal.classList.add('hide');
    }
  })

  document.addEventListener('keydown', e => {
    if (e.code === 'Space' && !gameEnded) {
      togglePause();
      modal.classList.add('hide');
    }
    if (e.code === 'KeyR') {
      location.reload();
    }
  });

  music.onended = () => gameOver();

  function gameOver() {
    gameEnded = true;
    music.pause();
    modal.classList.remove('hide');
    msg.innerHTML = 'Game Over!';
    msg.innerHTML += `<br/> You score is ${score.score}`;
    msg.innerHTML += `<br/> You max combo is ${combo.maxCombo}`;
    msg.innerHTML += `<br/> Press R to restart`;
  }

  let frames = 0;
  let notes = {};
  let vel = 4;
  let life = music.bpm / 10;
  let startTime = 0;
  let latestNote = mammamia[0];
  let latestNoteIndex = 0;
  let timer = 0;

  function update() {
    if (!life) gameOver();
    if (gameEnded || !gameOn) {
      return;
    }

    stage.clearRect(0, 0, 800, 500);
    frames ++;

    setupStage();

    let bpm = music.bpm;
    // let delay = Math.floor(3600 / bpm - Math.random() * vel / 2);
    if(!startTime){
      startTime = Date.now();
      timePaused = 0

    }else{
      timer = Math.ceil(Date.now() - startTime-timePaused);
      // console.log(timer, timePaused)
    }

    let notesKeys = Object.keys(notes);
      if(timer + time_on_screen >= latestNote[0]){
        let type = (latestNote[2] === "2" || latestNote[2] ==="1") ? 'don' : 'kat';
        let color = (latestNote[2] === "2" || latestNote[2] === "1") ? 'pink' : 'blue';
        let note = new Note(vel,color, type,latestNote[0]);
        notes[note.id] = note;
        latestNoteIndex += 1;
		    latestNote = mammamia[latestNoteIndex+1];
      }

    
    for (let i = 0; i < notesKeys.length; i++) {
      let id = notesKeys[i];
      let note = notes[id];
      note.render();
      note.move(timer);

      if (note.x > drum.x - 60 && note.x < drum.x) {
        for (let j = 0; j < drumKeys.length; j++) {
          let key = drumKeys[j];
          if (key.pressed) {
            // console.log(key)
            // console.log(key.type,note.type);
            key.pressed = false;
            // drum.flash();
            if (key.type === note.type) {
              combo.up();
              spiritGauge.up(combo.combo);
              score.up(spiritGauge.spirit);
              delete notes[id];
            } else {
              combo.reset();
            }
          }
        }
      } 
      if (note.x < -40) {
        spiritGauge.down();
        combo.reset();
        delete notes[id];
        life--;
      }
    }

    requestAnimationFrame(update);
  }
});