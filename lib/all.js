let mammamia = [[2692,"5","3"],[2890,"1","3"],[3087,"1","1"],[4271,"5","1"],[4666,"1","3"],[5061,"1","1"],[5456,"1","3"],[5653,"1","1"],[5850,"1","1"],[6245,"1","3"],[7035,"5","3"],[7232,"1","1"],[7429,"1","1"],[7824,"1","3"],[10094,"5","1"],[10390,"1","1"],[10785,"1","3"],[10982,"1","3"],[11771,"1","3"],[12166,"1","3"],[12363,"1","1"],[12956,"5","1"],[13153,"1","1"],[13548,"1","1"],[13745,"1","1"],[13942,"1","1"],[14140,"1","3"],[14337,"1","1"],[14929,"1","3"],[15127,"1","3"],[15324,"1","3"],[15719,"1","3"],[15916,"1","3"],[16113,"5","1"],[16508,"1","1"],[17495,"1","1"],[18087,"1","1"],[19469,"5","1"],[19666,"1","3"],[19863,"1","3"],[20061,"1","1"],[21048,"1","1"],[24798,"5","1"],[24995,"1","1"],[25587,"5","1"],[25982,"1","3"],[26377,"1","1"],[26771,"1","3"],[27561,"1","3"],[27758,"1","1"],[30324,"5","1"],[30719,"1","1"],[31113,"1","1"],[32495,"5","1"],[32692,"1","1"],[33285,"1","1"],[34271,"1","3"],[34666,"1","3"],[34863,"1","1"],[35456,"5","1"],[35850,"1","3"],[36048,"1","3"],[36640,"1","1"],[36837,"1","1"],[37035,"1","1"],[37429,"1","1"],[37627,"1","3"],[39008,"5","1"],[39403,"1","1"],[39798,"1","1"],[40192,"1","1"],[40390,"1","1"],[40587,"1","1"],[41771,"5","3"],[42166,"1","1"],[42363,"1","3"],[42758,"1","3"],[42956,"1","2"],[43350,"1","1"],[43745,"1","3"],[44140,"1","1"],[44535,"5","1"],[45324,"1","1"],[45719,"1","1"],[46508,"1","1"],[46706,"1","3"],[46903,"1","1"],[47298,"1","3"],[48087,"5","1"],[48877,"1","3"],[49666,"1","1"],[50061,"1","3"],[50456,"1","3"],[50653,"1","3"],[51245,"5","3"],[51442,"1","1"],[51640,"1","3"],[52035,"1","3"],[52824,"1","1"],[53021,"1","1"],[53613,"1","3"],[54008,"5","1"],[56179,"1","1"],[56969,"1","1"],[57561,"5","3"],[58153,"1","1"],[58350,"1","3"],[59140,"1","1"],[59337,"1","1"],[59732,"1","1"],[59929,"1","1"],[60127,"1","1"],[60719,"5","1"],[61113,"1","3"],[61508,"1","1"],[63087,"1","3"],[63877,"5","3"],[64074,"1","3"],[64469,"1","3"],[64666,"1","3"],[65456,"1","3"],[65653,"1","1"],[66048,"1","1"],[66245,"1","1"],[66442,"1","1"],[66640,"5","2"],[67232,"1","3"],[67824,"1","3"],[68416,"1","1"],[68613,"1","1"],[68811,"1","1"],[69008,"1","3"],[69206,"1","1"],[69600,"1","3"],[70390,"5","1"],[70785,"1","1"],[70982,"1","1"],[72166,"1","1"],[72363,"1","1"],[73942,"5","3"],[74140,"1","1"],[74929,"1","1"],[75324,"1","1"],[76113,"5","3"],[76706,"1","3"],[76903,"1","1"],[77100,"1","3"],[77298,"1","1"],[77495,"1","3"],[77692,"1","3"],[78087,"1","3"],[78285,"1","1"],[78482,"1","1"],[78679,"1","1"],[78877,"1","3"],[79074,"1","1"],[79666,"5","1"],[80850,"1","1"],[81048,"1","1"],[81245,"1","1"],[81640,"1","1"],[82035,"1","1"],[82429,"5","3"],[82824,"1","1"],[83219,"1","1"],[84600,"1","1"],[85192,"1","1"],[85982,"5","3"],[88350,"1","3"],[88745,"5","3"],[89140,"1","1"],[89732,"1","1"],[89929,"1","1"],[90324,"1","1"],[90521,"1","1"],[90916,"1","3"],[92692,"5","1"],[93087,"1","3"],[93877,"1","3"],[95456,"5","1"],[95850,"1","1"],[97035,"1","3"],[99008,"5","1"],[99600,"1","1"],[100785,"1","1"],[101771,"5","3"],[102166,"1","3"],[102956,"1","1"],[103350,"1","3"],[103548,"1","1"],[103745,"1","3"],[104929,"5","3"],[105324,"1","1"],[106113,"1","2"],[106508,"1","1"],[106903,"1","1"],[107298,"1","1"],[107692,"5","1"],[108087,"1","1"],[108482,"1","3"],[108877,"1","3"],[109074,"1","1"],[109666,"1","3"],[110061,"1","1"],[110456,"1","1"],[111245,"5","1"],[112035,"1","3"],[112232,"1","3"],[112429,"1","1"],[112824,"1","1"],[113219,"1","1"],[113613,"1","1"],[114403,"5","3"],[114600,"1","1"],[114798,"1","3"],[115192,"1","3"],[115390,"1","1"],[115982,"1","3"],[116377,"1","1"],[116771,"1","3"],[117166,"5","1"],[118153,"1","1"],[118350,"1","3"],[119337,"1","1"],[120719,"5","1"],[120916,"1","1"],[121311,"1","1"],[121508,"1","1"],[122298,"1","1"],[122890,"1","1"],[123285,"1","1"],[123877,"5","3"],[125850,"1","1"],[126245,"1","3"],[127035,"5","3"],[127232,"1","1"],[127429,"1","1"],[127627,"1","1"],[127824,"1","3"],[128613,"1","3"],[128811,"1","3"],[129206,"1","1"],[129403,"1","3"],[129600,"1","1"],[130192,"5","3"],[130982,"1","1"],[131179,"1","3"],[131574,"1","3"],[132166,"1","1"],[132363,"1","3"],[132758,"1","2"],[133350,"5","3"],[133548,"1","1"],[133942,"1","1"],[134140,"1","3"],[135324,"1","2"],[137298,"5","3"],[137692,"1","1"],[137890,"1","1"],[138482,"1","1"],[138679,"1","1"],[138877,"1","3"],[139271,"5","2"],[139469,"1","1"],[139863,"1","1"],[140061,"1","1"],[140258,"1","1"],[140456,"1","1"],[140653,"1","1"],[140850,"1","3"],[141442,"1","3"],[141640,"1","1"],[142035,"1","1"],[142232,"1","1"],[142429,"5","1"],[142824,"1","3"],[143219,"1","1"],[143416,"1","1"],[143811,"1","1"],[144008,"1","2"],[144206,"1","1"],[144403,"1","4"],[144798,"1","2"],[145192,"1","3"],[145390,"1","2"],[146377,"5","3"],[146771,"1","3"],[147166,"1","4"],[147561,"1","1"],[147956,"1","1"],[148350,"1","4"],[148548,"1","1"],[149337,"5","1"],[149535,"1","3"],[149732,"1","1"],[149929,"1","3"],[150127,"1","1"],[151113,"1","3"],[151903,"5","2"],[152890,"1","3"],[153087,"1","3"],[153877,"1","1"],[154271,"1","1"],[154666,"1","1"],[156048,"5","1"],[156245,"1","2"],[156442,"1","3"],[157429,"1","1"],[157824,"1","1"],[158021,"1","1"],[159008,"5","3"],[160192,"1","1"],[162166,"5","1"],[162561,"1","3"],[162758,"1","1"],[163350,"1","1"],[163745,"1","3"],[164929,"5","3"],[165324,"1","1"],[165719,"1","1"],[165916,"1","1"],[166508,"1","3"],[167692,"5","2"],[167890,"1","1"],[168087,"1","3"],[168285,"1","1"],[168482,"1","3"],[168877,"1","3"],[169666,"1","1"],[169863,"1","3"],[170061,"1","1"],[170456,"1","1"],[170653,"1","3"],[171245,"5","3"],[171640,"1","3"],[171837,"1","1"],[172035,"1","3"],[172232,"1","1"],[172824,"1","1"],[173021,"1","1"],[173416,"1","1"],[173613,"1","1"],[173811,"1","3"],[174008,"5","1"],[174403,"1","3"],[175192,"1","1"],[175982,"1","3"],[176377,"1","4"],[176574,"1","1"],[176771,"1","3"],[176969,"1","1"],[177758,"5","1"],[177956,"1","1"],[178153,"1","1"],[178350,"1","1"],[178745,"1","1"],[179140,"1","1"],[179337,"1","1"],[179732,"1","3"],[179929,"1","3"],[180127,"1","1"],[180916,"5","3"],[181903,"1","1"],[182495,"1","1"],[182692,"1","3"],[182890,"1","1"],[183285,"1","1"],[183679,"5","1"],[183877,"1","3"],[184271,"1","1"],[184469,"1","1"],[184666,"1","3"],[185061,"1","1"],[185850,"1","3"],[186837,"5","1"],[187232,"1","1"],[187429,"1","1"],[187627,"1","1"],[188613,"1","1"],[188811,"1","1"],[189008,"1","1"],[189206,"1","1"],[189798,"5","2"],[190390,"1","1"],[190587,"1","1"],[190982,"1","1"],[191179,"1","1"],[191771,"1","3"],[191969,"1","1"],[192166,"1","1"],[192363,"1","1"],[192561,"1","3"],[192758,"1","1"],[193350,"5","1"],[194337,"1","3"],[194535,"1","3"],[194929,"1","3"],[195719,"1","3"],[196903,"5","1"],[197495,"1","1"],[198285,"1","1"],[198679,"1","1"],[199271,"5","1"],[200061,"1","3"],[200653,"1","1"]];
let time_on_screen = 2000;
class Combo {
  constructor() {
    this.combo = 0;
    this.counter = document.getElementById('combo');
    this.maxCombo = 0;
  }

  render() {
    if (this.combo) {
      this.counter.innerHTML = `${this.combo} combo`;
    } else {
      if (!this.counter.innerHTML) {
        return;
      }
      this.counter.innerHTML = 'miss';
    }
  }

  show() {
    this.counter.classList.remove('bounceOutRight');
    this.counter.classList.add('bounceInRight');
  }

  hide() {
    this.counter.classList.remove('bounceInRight');
    this.counter.classList.add('bounceOutRight');
  }

  up() {
    this.combo ++;
    this.show();
    if (this.combo > this.maxCombo) {
      this.maxCombo = this.combo;
    }
  }

  reset() {
    this.combo = 0;
    this.hide();
  }
}

class Drum {
  constructor() {
    this.stage = document.getElementById('canvas').getContext('2d');
    this.x = 234;
    this.y = 204;
    this.colorRim = 'white';
    this.colorCenter = 'lightgrey';
  }

  render() {
    this.drawCircle(31, this.colorRim);
    this.drawCircle(20, this.colorCenter);
  }

  tap(note) {
    if (note.id === 'kat') {
      this.colorRim = 'skyblue';
    } else {
      this.colorCenter = 'orangered';
    }

    setTimeout(() => {
      this.colorRim = 'white';
      this.colorCenter = 'lightgrey';
    }, 100);
  }

  drawCircle(radius, color) {
    let stage = this.stage;
    stage.beginPath();
    stage.arc(this.x, this.y, radius, 0, 2 * Math.PI);
    stage.fillStyle = color;
    stage.fill();
  }

  flash() {
    // let stage = this.stage;
    // stage.beginPath();
    // stage.fillStyle = '#ffe92b';
    // stage.fillRect(150, 150, 80, 160);
  }
}

class DrumKey {
  constructor(drum, key) {
    this.drum = drum;
    this.key = key;
  }

  register(note) {
    this.type = note.id;

    document.addEventListener('keydown', e => {
      if (this.key === e.key) {
        this.pressed = true;
        note.currentTime = 0;
        note.play();
        this.drum.tap(note);
        setTimeout(() => {
          this.pressed = false;
        }, 100)
      }
    });

    document.addEventListener('keyup', e => {
      if (this.key === e.key.toLowerCase()) {
        this.pressed = false;
      }
    });
  }
}

class Note {
  constructor(vel, color, type,time) {
    this.x = 800;
    this.y = 173;
    this.vel = vel;
    this.id = Date.now();
    this.color = color;
    this.type = type;
    this.time = time;

    this.image = new Image();
    this.image.src = `./gifs/${color}_chestnut_note_500.png`;

    this.stage = document.getElementById('canvas').getContext('2d');
  }

  move(timer) {
    this.x = Math.floor(((this.time-timer)/time_on_screen)*566+234);
  }

  render() {
    this.stage.drawImage(this.image, this.x, this.y);
  }
}

class Score {
  constructor() {
    this.counter = document.getElementById('score-counter');
    this.score = 0;
  }

  render() {
    this.counter.innerHTML = this.score;
  }

  up(spirit) {
    let multiplier = spirit / 100;
    let score = Math.floor(100 * multiplier + 100);
    this.score += score;
  }
}

class SpiritGauge {
  constructor() {
    this.x = 340;
    this.y = 67;
    this.stage = document.getElementById('canvas').getContext('2d');
    this.spirit = 0;
    this.maxSpirit = 1000;
    this.maxWidth = 400;
  }

  render() {
    let stage = this.stage;
    stage.beginPath();
    stage.rect(this.x, this.y, this.maxWidth, 40);
    stage.fillStyle = 'white';
    stage.fillRect(this.x, this.y, this.maxWidth, 40);
    stage.lineWidth = 3;
    stage.strokeStyle = 'black';
    stage.stroke();

    this.bar();
    this.lit();
  }

  up(combo) {
    if (this.spirit < this.maxSpirit) {
      let spirit = 1 + combo;
      this.spirit += spirit;
    }
  }

  down() {
    if (this.spirit > 0) {
      this.spirit --;
    }
  }

  bar() {
    let width = this.spirit / this.maxSpirit * this.maxWidth;
    if (width >= this.maxWidth) {
      width = this.maxWidth;
      this.full = true;
    } else {
      this.full = false;
    }
    this.stage.fillStyle = '#ffe92b';
    this.stage.fillRect(this.x + 3, this.y + 3, width, 34);
  }

  lit() {
    let fire = document.getElementById('fire');
    if (this.full) {
      fire.classList.remove('hide');
    } else {
      fire.classList.add('hide');
    }
  }
}

class ToggleMusic {
  constructor(music) {
    this.music = music;
    this.volumeOn = document.getElementById('volume-on');
    this.volumeOff = document.getElementById('volume-off');
    this.musicMute = document.querySelector('.music-mute');
    this.init();
  }

  init() {
    this.musicMute.addEventListener('click', e => this.render());
    document.addEventListener('keypress', e => {
      if (e.code === 'KeyM') {
        this.render();
      }
    });
  }

  render() {
    this.music.muted = this.music.muted ? false : true;
    this.volumeOn.classList.toggle('hide', this.music.muted);
    this.volumeOff.classList.toggle('hide', !this.music.muted);
  }
}

class TogglePlay {
  constructor() {
    this.gameOn = false;
    this.play = document.getElementById('play');
    this.pause = document.getElementById('pause');
  }

  render() {
    this.gameOn = this.gameOn ? false : true;
    this.play.classList.toggle('hide', this.gameOn);
    this.pause.classList.toggle('hide', !this.gameOn);
  }
}

const buttonPositions = {
  bluearea1: {
    x: 0,
    y: 260,
    width: 250,
    height: 200
  },
  bluearea2: {
    x: 500,
    y: 260,
    width: 250,
    height: 200
  },
  pinkarea: {
    x: 260,
    y: 260,
    width: 300,
    height: 150
  }
};

function isInside(pos, rect, desc){
  return pos.x > rect.x && pos.x < rect.x+rect.width && pos.y < rect.y+rect.height && pos.y > rect.y
}

// Get the mouse position
function getMousePos(canvas, e) {
    var rect = canvas.getBoundingClientRect();
    return {
        x: Math.round((e.clientX - rect.left)/(rect.right - rect.left)*canvas.width),
        y: Math.round((e.clientY - rect.top)/(rect.bottom - rect.top)*canvas.height)
    };
}



document.addEventListener('DOMContentLoaded', () => {
  const mammamiaAudio = document.createElement('audio');
  mammamiaAudio.src = "./sounds/audio.mp3";
  mammamiaAudio.bpm = 152;


  const don = new Audio();
  const kat = new Audio();
  don.id = 'don';
  kat.id = 'kat';
  don.src = './sounds/don.mp3';
  kat.src = './sounds/kat.mp3';

  let songLib = [mammamiaAudio];
  let songId = Math.floor(Math.random() * songLib.length);
  let music = songLib[songId];
  music.volume = 0.5;

  const toggleMusic = new ToggleMusic(music);
  const togglePlay = new TogglePlay();
  const canvas = document.getElementById('canvas');
  const stage = canvas.getContext('2d');
  const score = new Score();
  const spiritGauge = new SpiritGauge();
  const combo = new Combo();
  const drum = new Drum();

  // function NotesArea() {
  //   stage.beginPath();
  //   stage.lineWidth = 5;
  //   stage.moveTo(0, 150);
  //   stage.lineTo(800, 150);
  //   stage.stroke();
  //   stage.fillStyle = 'lightgrey';
  //   stage.fillRect(0, 150, 800, 200);
  //   stage.fillStyle = 'black';
  //   stage.fillRect(0, 310, 800, 40);
  //   stage.fill();
  // }

  const keyA = new DrumKey(drum, 'ArrowLeft');
  const keyB = new DrumKey(drum, 'ArrowRight');
  const drumKeys = [keyA, keyB];
  keyA.register(don);
  keyB.register(kat);

   function togglePause() {
      if (musicOn) {
        musicOn = false;
        pauseStart = Date.now();
        music.pause();
      } else {
        musicOn = true;
        // console.log(pauseStart);
        // console.log(timePaused);
        timePaused = Math.ceil(Date.now()-pauseStart)+timePaused;
        // console.log(timePaused)
        music.play();
      }
      togglePlay.render();
  
      gameOn = gameOn ? false : true;
      update();
  }

  // On mouse button click
  function onMouseDown(e) {
      // Get the mouse position
      var pos = getMousePos(canvas, e);
      // console.log(pos.x, pos.y);
      // console.log(e.clientX,e.clientY)
      if (!gameOn) {
        console.log('game not on')
        togglePause();
        modal.classList.add('hide');
      }
      //TODO: song selection and game state
      // if (gamestate == gamestates.gameover) {
      //     newGame();
      // } else if (gamestate == gamestates.win) {
      //     endscreen.style.display = 'none';

      //     var tilefound = false
      //     for (var i=0; i<level.columns; i++) {
      //         for (var j=0; j<level.rows; j++) {
      //             if (level.tiles[i][j].type != -1) {
      //                 tilefound = true;
      //                 break;
      //             }
      //         }
      //     }

      //     if (!tilefound) {
      //         createLevel();
      //     }
      //     setGameState(gamestates.ready)
      // } else if (gamestate == gamestates.displaygif){
      //     gifs[gifnum].style.display = 'none';
      //     // closebutton.style.display = 'none';
      //     gifnum = (gifnum + 1)%5;
      //     setGameState(gamestates.removecluster);
      // }
      else if (isInside(pos,buttonPositions["bluearea1"],"bluearea1") || isInside(pos,buttonPositions["bluearea2"],"bluearea2") ) {
             // console.log("kat")
            keyB.pressed = true;
            kat.currentTime = 0;
            // kat.play();  //seems like these cause lag :( )
            keyB.drum.tap(kat);
            setTimeout(() => {
              keyB.pressed = false;
            }, 100)
      }
      else if (isInside(pos,buttonPositions["pinkarea"],"pinkarea")) {
            // console.log("don")
            keyA.pressed = true;
            don.currentTime = 0;
            // don.play(); //seems like these cause lag :( )
            keyA.drum.tap(don);
            setTimeout(() => {
              keyA.pressed = false;
            }, 100)
      }
      // else if (isInside(pos,directionButtons["rightButton"])) {
      //     console.log("right")
      //     mousedownright = true;
      //     if (IS_MOBILE){
      //         console.log("mobile right")
      //         player.angle = Math.max(8, player.angle-2);
      //         if (charframe == 2) {
      //             charframe = 3;
      //         } else if (charframe == 3) {
      //             charframe = 1;
      //         } else if (charframe == 1) {
      //             charframe = 2;
      //         } else if (charframe == 0) {
      //             charframe = 1;
      //         };
      //     }
        //player.angle = Math.max(8, player.angle-2);
      // }
      //TODO: Can use this for song selection
      // for (var i=0;i<unlockIndex;i++){
      //     if (isInside(pos,playerButtons[i])){
      //         player.selectedSprite = i;
      //     }
      // }
  }

  function onMouseUp(e) {
      // Get the mouse position
      keyA.pressed = false;
      keyB.pressed = false;
  }
  function onTouchStart(e){
    e.clientX = e.touches[0].clientX;
    e.clientY = e.touches[0].clientY;
    // console.log("Touching",e.clientX,e.clientY)
    onMouseDown(e);
  }
  function onTouchEnd(e){
      // console.log("Touch ended");
      onMouseUp(e);
  }
  canvas.addEventListener("mousedown", onMouseDown);
  canvas.addEventListener("touchstart", onTouchStart);
  canvas.addEventListener("touchend", onTouchEnd);
  canvas.addEventListener("mouseup", onMouseUp);



  function setupStage() {
    // NotesArea();
    drum.render();
    score.render();
    // spiritGauge.render();
    // combo.render();
  }
  setupStage();

  let musicOn, gameOn, gameEnded;
  let pauseStart = Date.now();
  let timePaused = 0;
  let msg = document.getElementById('msg');
  let restart = document.getElementById('restart');
  let modal = document.querySelector('.modal');
  let playPause = document.querySelector('.play-pause');

  playPause.addEventListener('click', () => togglePause());
  restart.addEventListener('click', () => location.reload());
  modal.addEventListener('click', () => {
    if (!gameEnded) {
      togglePause();
      modal.classList.add('hide');
    }
  })

  document.addEventListener('keydown', e => {
    if (e.code === 'Space' && !gameEnded) {
      togglePause();
      modal.classList.add('hide');
    }
    if (e.code === 'KeyR') {
      location.reload();
    }
  });

  music.onended = () => gameOver();

  function gameOver() {
    gameEnded = true;
    music.pause();
    modal.classList.remove('hide');
    msg.innerHTML = 'Game Over!';
    msg.innerHTML += `<br/> You score is ${score.score}`;
    msg.innerHTML += `<br/> You max combo is ${combo.maxCombo}`;
    msg.innerHTML += `<br/> Press R to restart`;
  }

  let frames = 0;
  let notes = {};
  let vel = 4;
  let life = music.bpm / 10;
  let startTime = 0;
  let latestNote = mammamia[0];
  let latestNoteIndex = 0;
  let timer = 0;

  function update() {
    if (!life) gameOver();
    if (gameEnded || !gameOn) {
      return;
    }

    stage.clearRect(0, 0, 800, 500);
    frames ++;

    setupStage();

    let bpm = music.bpm;
    // let delay = Math.floor(3600 / bpm - Math.random() * vel / 2);
    if(!startTime){
      startTime = Date.now();
      timePaused = 0

    }else{
      timer = Math.ceil(Date.now() - startTime-timePaused);
      // console.log(timer, timePaused)
    }

    let notesKeys = Object.keys(notes);
      if(timer + time_on_screen >= latestNote[0]){
        let type = (latestNote[2] === "2" || latestNote[2] ==="1") ? 'don' : 'kat';
        let color = (latestNote[2] === "2" || latestNote[2] === "1") ? 'pink' : 'blue';
        let note = new Note(vel,color, type,latestNote[0]);
        notes[note.id] = note;
        latestNoteIndex += 1;
		    latestNote = mammamia[latestNoteIndex+1];
      }

    
    for (let i = 0; i < notesKeys.length; i++) {
      let id = notesKeys[i];
      let note = notes[id];
      note.render();
      note.move(timer);

      if (note.x > drum.x - 60 && note.x < drum.x) {
        for (let j = 0; j < drumKeys.length; j++) {
          let key = drumKeys[j];
          if (key.pressed) {
            // console.log(key)
            // console.log(key.type,note.type);
            key.pressed = false;
            // drum.flash();
            if (key.type === note.type) {
              combo.up();
              spiritGauge.up(combo.combo);
              score.up(spiritGauge.spirit);
              delete notes[id];
            } else {
              combo.reset();
            }
          }
        }
      } 
      if (note.x < -40) {
        spiritGauge.down();
        combo.reset();
        delete notes[id];
        life--;
      }
    }

    requestAnimationFrame(update);
  }
});